<?xml version='1.1' encoding='UTF-8'?>
<project>
  <actions/>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties/>
  <scm class="hudson.scm.NullSCM"/>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers/>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>
if [ -f &quot;/usr/local/docker-config/setProxy.sh&quot; ]; then
   . /usr/local/docker-config/setProxy.sh
fi

mkdir -p /var/log/hpds-logs
mkdir -p /var/log/httpd-docker-logs
mkdir -p /var/log/wildfly-docker-logs
mkdir -p /var/log/wildfly-docker-os-logs/
mkdir -p /usr/local/docker-config/wildfly/passthru
mkdir -p /usr/local/docker-config/wildfly/aggregate-data-sharing/
mkdir -p /usr/local/docker-config/wildfly/emailTemplates

sed  &apos;/wildfly/d&apos; /etc/hosts &gt; hosts.new &amp;&amp; cat hosts.new &gt; /etc/hosts
sed  &apos;/httpd/d&apos; /etc/hosts &gt; hosts.new &amp;&amp; cat hosts.new &gt; /etc/hosts
sed  &apos;/hpds/d&apos; /etc/hosts &gt; hosts.new &amp;&amp; cat hosts.new &gt; /etc/hosts

if [ -z &quot;$(grep queryExportType /usr/local/docker-config/httpd/picsureui_settings.json | grep DISABLED)&quot; ]; then
	export EXPORT_SIZE=&quot;2000&quot;;
else
	export EXPORT_SIZE=&quot;0&quot;;
fi

export WILDFLY_JAVA_OPTS=&quot;-Xms2g -Xmx4g -XX:MetaspaceSize=96M -XX:MaxMetaspaceSize=256m -Djava.net.preferIPv4Stack=true $PROXY_OPTS&quot;
export HPDS_OPTS=&quot;-XX:+UseParallelGC -XX:SurvivorRatio=250 -Xms1g -Xmx16g -server -jar hpds.jar -httpPort 8080 -DCACHE_SIZE=1500 -DSMALL_TASK_THREADS=1 -DLARGE_TASK_THREADS=1 -DSMALL_JOB_LIMIT=100 -DID_BATCH_SIZE=$EXPORT_SIZE -DALL_IDS_CONCEPT=NONE -DID_CUBE_NAME=NONE&quot;
export PICSURE_SETTINGS_VOLUME=&quot;-v /usr/local/docker-config/httpd/picsureui_settings.json:/usr/local/apache2/htdocs/picsureui/settings/settings.json&quot;
export EMAIL_TEMPLATE_VOUME=&quot;-v /usr/local/docker-config/wildfly/emailTemplates:/opt/jboss/wildfly/standalone/configuration/emailTemplates &quot;

# these debug options can be added to wildfly or hpds container startup to enable remote debugging or profiling.
# Don&apos;t forget to add a port mapping too!
export DEBUG_OPTS=&quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=0.0.0.0:8000&quot;
export PROFILING_OPTS=&quot;-Dcom.sun.management.jmxremote.port=9000 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=localhost&quot;

if [ -f /usr/local/docker-config/wildfly/application.truststore ]; then
	export TRUSTSTORE_VOLUME=&quot;-v /usr/local/docker-config/wildfly/application.truststore:/opt/jboss/wildfly/standalone/configuration/application.truststore&quot;
   	export TRUSTSTORE_JAVA_OPTS=&quot;-Djavax.net.ssl.trustStore=/opt/jboss/wildfly/standalone/configuration/application.truststore -Djavax.net.ssl.trustStorePassword=password&quot;
fi

docker network inspect picsure --format &quot;{{.Name}}: {{.Id}}&quot; 2&gt;&amp;1  ||  docker network create picsure
docker network inspect hpdsNet --format &quot;{{.Name}}: {{.Id}}&quot; 2&gt;&amp;1  ||  docker network create hpdsNet

docker stop hpds &amp;&amp; docker rm -f hpds
docker run --name=hpds --hostname=hpds --restart always --network=hpdsNet \
  -v /etc/hosts:/etc/hosts \
  -v /usr/local/docker-config/hpds:/opt/local/hpds \
  -v /usr/local/docker-config/hpds/all:/opt/local/hpds/all \
  -v /var/log/hpds-logs/:/var/log/ \
  --entrypoint=java \
  -d hms-dbmi/pic-sure-hpds:LATEST $HPDS_OPTS


if [ -f /usr/local/docker-config/httpd/custom_httpd_volumes ]; then
	export CUSTOM_HTTPD_VOLUMES=&quot;`cat /usr/local/docker-config/httpd/custom_httpd_volumes`&quot;
fi

if [ -f /usr/local/docker-config/httpd/connections.json ]; then
        export CONNECTIONS_VOLUME=&quot;-v /usr/local/docker-config/httpd/connections.json:/usr/local/apache2/htdocs/picsureui/psamaui/login/connections.json&quot;
fi


docker stop httpd &amp;&amp; docker rm -f httpd
docker run --security-opt label=disable --name=httpd --hostname=httpd --restart always --network=picsure \
  -v /etc/hosts:/etc/hosts \
  -v /var/log/httpd-docker-logs/:/usr/local/apache2/logs/ \
  $PICSURE_SETTINGS_VOLUME \
  -v /usr/local/docker-config/httpd/cert:/usr/local/apache2/cert/ \
  $CUSTOM_HTTPD_VOLUMES \
  $CONNECTIONS_VOLUME \
  -p 80:80 \
  -p 443:443 \
  -d hms-dbmi/pic-sure-ui-overrides:LATEST
docker exec httpd sed -i &apos;/^#LoadModule proxy_wstunnel_module/s/^#//&apos; conf/httpd.conf
docker restart httpd


docker stop wildfly &amp;&amp; docker rm -f wildfly
docker create --security-opt label=disable --name=wildfly --hostname=wildfly --restart always --network=picsure -u root \
  -v /var/log/wildfly-docker-logs/:/opt/jboss/wildfly/standalone/log/ \
  -v /etc/hosts:/etc/hosts \
  -v /var/log/wildfly-docker-os-logs/:/var/log/ \
  -v /usr/local/docker-config/wildfly/passthru/:/opt/jboss/wildfly/standalone/configuration/passthru/ \
  -v /usr/local/docker-config/wildfly/aggregate-data-sharing/:/opt/jboss/wildfly/standalone/configuration/aggregate-data-sharing/ \
  -v /usr/local/docker-config/wildfly/deployments/:/opt/jboss/wildfly/standalone/deployments/ \
  -v /usr/local/docker-config/wildfly/standalone.xml:/opt/jboss/wildfly/standalone/configuration/standalone.xml \
  $TRUSTSTORE_VOLUME \
  $EMAIL_TEMPLATE_VOUME \
  -v /usr/local/docker-config/wildfly/wildfly_mysql_module.xml:/opt/jboss/wildfly/modules/system/layers/base/com/sql/mysql/main/module.xml  \
  -v /usr/local/docker-config/wildfly/mysql-connector-java-5.1.49.jar:/opt/jboss/wildfly/modules/system/layers/base/com/sql/mysql/main/mysql-connector-java-5.1.49.jar \
  -e JAVA_OPTS=&quot;$WILDFLY_JAVA_OPTS $TRUSTSTORE_JAVA_OPTS&quot; \
   hms-dbmi/pic-sure-jbosseap:LATEST
   
docker network connect hpdsNet wildfly
docker start wildfly

httpIP=$(podman  inspect --format &apos;{{ .NetworkSettings.Networks.picsure.IPAddress }}&apos; httpd);
wildflyIP=$(podman  inspect --format &apos;{{ .NetworkSettings.Networks.picsure.IPAddress }}&apos; wildfly);
hpdsIP=$(podman  inspect --format &apos;{{ .NetworkSettings.Networks.hpdsNet.IPAddress }}&apos; hpds);

echo &quot;$httpIP httpd httpd&quot; &gt;&gt; /etc/hosts
echo &quot;$wildflyIP wildfly wildfly&quot; &gt;&gt; /etc/hosts
echo &quot;$hpdsIP hpds hpds&quot; &gt;&gt; /etc/hosts

</command>
      <configuredLocalRules/>
    </hudson.tasks.Shell>
  </builders>
  <publishers/>
  <buildWrappers/>
</project>
